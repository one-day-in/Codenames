import{s as k,a as L,t as N,D as _}from"./url-oOUZ7you.js";import{c as R}from"./resize-Cd5pde_8.js";const h=3e4,o={GUIDE_RESONANT:"guide-resonant",GUIDE_DISSONANT:"guide-dissonant",WALKER_RESONANT:"walker-resonant",WALKER_DISSONANT:"walker-dissonant"},A=Object.values(o);function p(a){let e=null,i={},s={};function f(){return{[o.GUIDE_RESONANT]:!1,[o.GUIDE_DISSONANT]:!1,[o.WALKER_RESONANT]:!1,[o.WALKER_DISSONANT]:!1}}function r(){if(!e)return f();const t=e.presenceState(),n=f();return Object.values(t).forEach(c=>c.forEach(l=>{l.role in n&&(n[l.role]=!0)})),n}function d(){var n;const t=r();(n=i.onChange)==null||n.call(i,t,A.every(c=>t[c]))}function S(t){e||(e=k.channel("presence-"+a,{config:{presence:{key:t||"host"}}}),e.on("presence",{event:"join"},({key:n})=>{s[n]&&(clearTimeout(s[n]),delete s[n]),d()}).on("presence",{event:"leave"},({key:n})=>{s[n]=setTimeout(()=>{delete s[n],d()},h)}).subscribe(async n=>{n==="SUBSCRIBED"&&t&&(await e.track({role:t}),d())}))}async function E(t){return new Promise(n=>{const c="check-"+a+"-"+Date.now(),l=k.channel(c);let v=!1;function T(m){v||(v=!0,k.removeChannel(l),n(m))}l.on("presence",{event:"sync"},()=>{const m=Object.values(l.presenceState()).some(g=>g.some(w=>w.role===t));T(m)}).subscribe(),setTimeout(()=>T(!1),5e3)})}function u(){e&&(e.untrack(),k.removeChannel(e),e=null),Object.values(s).forEach(clearTimeout),s={}}return{listen:()=>S(null),join:t=>S(t),leave:u,onChange:t=>{i.onChange=t},getPresenceState:r,allConnected:()=>A.every(t=>r()[t]),isRoleTaken:E}}async function b(){if(!("wakeLock"in navigator))return null;try{return await navigator.wakeLock.request("screen")}catch{return null}}async function y(a,e){let i=await b();document.addEventListener("visibilitychange",async()=>{if(document.visibilityState==="visible"&&(i!=null&&i.released&&(i=await b()),e))try{a.leave(),a.join(e)}catch{}}),window.addEventListener("online",()=>{if(e)try{a.leave(),a.join(e)}catch{}})}function O(a,e){return a==="guide"?e==="resonant"?o.GUIDE_RESONANT:o.GUIDE_DISSONANT:e==="resonant"?o.WALKER_RESONANT:o.WALKER_DISSONANT}function D(a,e,i){return a==="walker"?`${e} ${i.dreamwalker}<br>${i.controllerTaken.replace(`
`,"<br>")}`:i[e==="resonant"?"miniTakenResonant":"miniTakenDissonant"].replace(`
`,"<br>")}async function j(a,{roleType:e,invalidParamsHtml:i}){const{roomId:s,token:f,team:r}=L();if(!s||!f||!r||r!=="resonant"&&r!=="dissonant")return a.innerHTML=i,null;const{data:d,error:S}=await k.from("rooms").select("id, guest_token").eq("id",s).eq("guest_token",f).maybeSingle();if(!d||S){const c=N(_);return a.innerHTML=`<div class="waiting-screen">
            <p>${c.wrongLink.replace(`
`,"<br>")}</p>
        </div>`,null}const E=O(e,r),u=p(s);if(await u.isRoleTaken(E)){const c=N(_);a.innerHTML=`
            <div class="waiting-screen">
                <div class="taken-screen">
                    <p class="taken-screen__icon">ðŸ”’</p>
                    <p class="taken-screen__text">${D(e,r,c)}</p>
                    <button class="lobby__btn" id="forceJoinBtn">${c.forceRejoin}</button>
                </div>
            </div>`,await new Promise(l=>{document.getElementById("forceJoinBtn").addEventListener("click",l,{once:!0})})}u.join(E),y(u,E),document.body.classList.add(`team-${r}`);const n=R(s);return await n.init(),{presence:u,store:n,team:r,roomId:s}}export{j as i};
