import{s as m,a as y,t as T,D as N}from"./url-oOUZ7you.js";import{c as L}from"./sanitize-s2klz6Q2.js";const b=3e4,s={GUIDE_RESONANT:"guide-resonant",GUIDE_DISSONANT:"guide-dissonant",WALKER_RESONANT:"walker-resonant",WALKER_DISSONANT:"walker-dissonant"},_=Object.values(s);function w(i){let e=null,a={},r={},l=null;function c(){return{[s.GUIDE_RESONANT]:!1,[s.GUIDE_DISSONANT]:!1,[s.WALKER_RESONANT]:!1,[s.WALKER_DISSONANT]:!1}}function S(){if(!e)return c();const t=e.presenceState(),n=c();return Object.values(t).forEach(o=>o.forEach(E=>{E.role in n&&(n[E.role]=!0)})),n}function u(){var n;const t=S();(n=a.onChange)==null||n.call(a,t,_.every(o=>t[o]))}function f(t){if(e){t&&l!==t&&(l=t,e.track({role:t}).then(u).catch(()=>{}));return}e=m.channel("presence-"+i,{config:{presence:{key:t||"host"}}}),e.on("presence",{event:"sync"},()=>{var n;u(),(n=a.onSync)==null||n.call(a)}).on("presence",{event:"join"},({key:n})=>{r[n]&&(clearTimeout(r[n]),delete r[n]),u()}).on("presence",{event:"leave"},({key:n})=>{r[n]=setTimeout(()=>{delete r[n],u()},b)}).subscribe(async n=>{n==="SUBSCRIBED"&&t&&(l=t,await e.track({role:t}),u())})}async function d(t){return new Promise(n=>{let o=!1;f(null);function E(k){o||(o=!0,a.onSync=void 0,n(k))}a.onSync=()=>{const k=Object.values(e.presenceState()).some(g=>g.some(R=>R.role===t));E(k)},setTimeout(()=>E(!1),5e3)})}function v(){e&&(e.untrack(),m.removeChannel(e),e=null,l=null),Object.values(r).forEach(clearTimeout),r={}}return{listen:()=>f(null),join:t=>f(t),leave:v,onChange:t=>{a.onChange=t},getPresenceState:S,allConnected:()=>_.every(t=>S()[t]),isRoleTaken:d}}async function A(){if(!("wakeLock"in navigator))return null;try{return await navigator.wakeLock.request("screen")}catch{return null}}async function p(i,e){let a=await A();document.addEventListener("visibilitychange",async()=>{if(document.visibilityState==="visible"&&(a!=null&&a.released&&(a=await A()),e))try{i.leave(),i.join(e)}catch{}}),window.addEventListener("online",()=>{if(e)try{i.leave(),i.join(e)}catch{}})}function O(i,e){return i==="guide"?e==="resonant"?s.GUIDE_RESONANT:s.GUIDE_DISSONANT:e==="resonant"?s.WALKER_RESONANT:s.WALKER_DISSONANT}function h(i,e,a){return i==="walker"?`${e} ${a.dreamwalker}<br>${a.controllerTaken.replace(`
`,"<br>")}`:a[e==="resonant"?"miniTakenResonant":"miniTakenDissonant"].replace(`
`,"<br>")}async function G(i,{roleType:e,invalidParamsHtml:a}){const{roomId:r,token:l,team:c}=y();if(!r||!l||!c||c!=="resonant"&&c!=="dissonant")return i.innerHTML=a,null;const{data:S,error:u}=await m.from("rooms").select("id, guest_token").eq("id",r).eq("guest_token",l).maybeSingle();if(!S||u){const n=T(N);return i.innerHTML=`<div class="waiting-screen">
            <p>${n.wrongLink.replace(`
`,"<br>")}</p>
        </div>`,null}const f=O(e,c),d=w(r);if(await d.isRoleTaken(f)){const n=T(N);i.innerHTML=`
            <div class="waiting-screen">
                <div class="taken-screen">
                    <p class="taken-screen__icon">ðŸ”’</p>
                    <p class="taken-screen__text">${h(e,c,n)}</p>
                    <button class="lobby__btn" id="forceJoinBtn">${n.forceRejoin}</button>
                </div>
            </div>`,await new Promise(o=>{document.getElementById("forceJoinBtn").addEventListener("click",o,{once:!0})})}d.join(f),p(d,f),document.body.classList.add(`team-${c}`);const t=L(r);return await t.init(),{presence:d,store:t,team:c,roomId:r}}export{G as i};
