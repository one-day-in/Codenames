import{s as u}from"./url-DMe9pim_.js";import{D as f}from"./i18n-pkrfkOVn.js";function w(){const e=new Set;let t;return{subscribe(n){if(e.add(n),t!==void 0)try{n(t)}catch(l){console.error(l)}return()=>e.delete(n)},emit(n){t=n,e.forEach(l=>{try{l(n)}catch(s){console.error(s)}})},clear(){e.clear(),t=void 0}}}const c={resonant:"dissonant",dissonant:"resonant"};function y(e,t){if(e.gameOver)return e;const n=e.cells[t];if(n.revealed)return e;const l=e.cells.map((a,v)=>v===t?{...a,revealed:!0}:a);if(n.role==="nightmare")return{...e,cells:l,gameOver:!0,winner:c[e.turn.team]};const s=e.turn.dreamwalkerMoves+1,i=e.turn.guideLimit!==null&&s>=e.turn.guideLimit,r=!(n.role===e.turn.team)||i?{team:c[e.turn.team],guideLimit:null,dreamwalkerMoves:0}:{...e.turn,dreamwalkerMoves:s};return{...e,cells:l,turn:r}}function h(e){return e.gameOver?e:{...e,turn:{team:c[e.turn.team],guideLimit:null,dreamwalkerMoves:0}}}function b(e,t){return e.gameOver||e.turn.guideLimit!==null?e:{...e,turn:{...e.turn,guideLimit:t}}}function p(e){if(e.gameOver)return e.winner;const t=e.cells.filter(i=>i.role==="resonant").length,n=e.cells.filter(i=>i.role==="dissonant").length,l=e.cells.filter(i=>i.role==="resonant"&&i.revealed).length,s=e.cells.filter(i=>i.role==="dissonant"&&i.revealed).length;return l===t?"resonant":s===n?"dissonant":null}function k(e){const t=w();let n=null,l=f;function s(r,a){r!==void 0&&(n=r),a!==void 0&&(l=a??f),t.emit({state:n,language:l})}function i(r){const a=p(r);return a?{...r,gameOver:!0,winner:a}:r}async function o(r){const a=i(r);await u.from("rooms").update({state:a}).eq("id",e)}async function d(){u.channel("room-"+e).on("postgres_changes",{event:"*",schema:"public",table:"rooms",filter:`id=eq.${e}`},a=>s(a.new.state,a.new.language)).subscribe();const{data:r}=await u.from("rooms").select("state, language").eq("id",e).maybeSingle();r&&s(r.state,r.language)}return{init:d,subscribe:t.subscribe,getState:()=>n,getLanguage:()=>l,startGame:async()=>{if(!n||n.phase!=="lobby")return;const r={...n,phase:"active"};await u.from("rooms").update({state:r}).eq("id",e)},resetGame:async()=>{await u.from("rooms").update({state:null}).eq("id",e)},setGuideLimit:async r=>{!n||n.gameOver||await o(b(n,r))},reveal:async r=>{!n||n.gameOver||await o(y(n,r))},endTurn:async()=>{!n||n.gameOver||await o(h(n))}}}function O(e){return e.revealed?e.role==="anomaly"?`main-cell--anomaly-${e.anomalyVariant||1}`:`main-cell--${e.role}`:"main-cell--hidden"}function C(e){const t=`mini-cell--${e.role}`;return e.revealed?`${t} mini-cell--revealed`:t}function T(e){return e.revealed?e.role==="anomaly"?"controller__cell--anomaly":`controller__cell--${e.role}`:"controller__cell--hidden"}async function m(){if(!("wakeLock"in navigator))return null;try{return await navigator.wakeLock.request("screen")}catch{return null}}async function E(e,t){let n=await m();document.addEventListener("visibilitychange",async()=>{if(document.visibilityState==="visible"&&(n!=null&&n.released&&(n=await m()),t))try{e.leave(),e.join(t)}catch{}}),window.addEventListener("online",()=>{if(t)try{e.leave(),e.join(t)}catch{}})}export{C as a,T as b,k as c,O as g,E as k};
