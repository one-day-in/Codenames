import{D as f,s as l}from"./url-oOUZ7you.js";function v(){const e=new Set;let r;return{subscribe(t){if(e.add(t),r!==void 0)try{t(r)}catch(a){console.error(a)}return()=>e.delete(t)},emit(t){r=t,e.forEach(a=>{try{a(t)}catch(u){console.error(u)}})},clear(){e.clear(),r=void 0}}}const c={resonant:"dissonant",dissonant:"resonant"};function w(e,r){if(e.gameOver)return e;const t=e.cells[r];if(t.revealed)return e;const a=e.cells.map((i,m)=>m===r?{...i,revealed:!0}:i);if(t.role==="nightmare")return{...e,cells:a,gameOver:!0,winner:c[e.turn.team]};const u=e.turn.dreamwalkerMoves+1,s=e.turn.guideLimit!==null&&u>=e.turn.guideLimit,n=!(t.role===e.turn.team)||s?{team:c[e.turn.team],guideLimit:null,dreamwalkerMoves:0}:{...e.turn,dreamwalkerMoves:u};return{...e,cells:a,turn:n}}function p(e){return e.gameOver?e:{...e,turn:{team:c[e.turn.team],guideLimit:null,dreamwalkerMoves:0}}}function h(e,r){return e.gameOver||e.turn.guideLimit!==null?e:{...e,turn:{...e.turn,guideLimit:r}}}function b(e){if(e.gameOver)return e.winner;const r=e.cells.filter(s=>s.role==="resonant").length,t=e.cells.filter(s=>s.role==="dissonant").length,a=e.cells.filter(s=>s.role==="resonant"&&s.revealed).length,u=e.cells.filter(s=>s.role==="dissonant"&&s.revealed).length;return a===r?"resonant":u===t?"dissonant":null}function O(e){const r=v();let t=null,a=f;function u(n,i){n!==void 0&&(t=n),i!==void 0&&(a=i??f),r.emit({state:t,language:a})}function s(n){const i=b(n);return i?{...n,gameOver:!0,winner:i}:n}async function o(n){const i=s(n);await l.from("rooms").update({state:i}).eq("id",e)}async function d(){l.channel("room-"+e).on("postgres_changes",{event:"*",schema:"public",table:"rooms",filter:`id=eq.${e}`},i=>u(i.new.state,i.new.language)).subscribe();const{data:n}=await l.from("rooms").select("state, language").eq("id",e).maybeSingle();n&&u(n.state,n.language)}return{init:d,subscribe:r.subscribe,getState:()=>t,getLanguage:()=>a,startGame:async()=>{if(!t||t.phase!=="lobby")return;const n={...t,phase:"active"};await l.from("rooms").update({state:n}).eq("id",e)},resetGame:async()=>{await l.from("rooms").update({state:null}).eq("id",e)},setGuideLimit:async n=>{!t||t.gameOver||await o(h(t,n))},reveal:async n=>{!t||t.gameOver||await o(w(t,n))},endTurn:async()=>{!t||t.gameOver||await o(p(t))}}}export{O as c};
