import{D as f,s as o}from"./url-oOUZ7you.js";function m(){const e=new Set;let r;return{subscribe(t){if(e.add(t),r!==void 0)try{t(r)}catch(s){console.error(s)}return()=>e.delete(t)},emit(t){r=t,e.forEach(s=>{try{s(t)}catch(u){console.error(u)}})},clear(){e.clear(),r=void 0}}}const c={resonant:"dissonant",dissonant:"resonant"};function v(e,r){if(e.gameOver)return e;const t=e.cells[r];if(t.revealed)return e;const s=e.cells.map((a,w)=>w===r?{...a,revealed:!0}:a);if(t.role==="nightmare")return{...e,cells:s,gameOver:!0,winner:c[e.turn.team]};const u=e.turn.dreamwalkerMoves+1,i=e.turn.guideLimit!==null&&u>=e.turn.guideLimit,n=!(t.role===e.turn.team)||i?{team:c[e.turn.team],guideLimit:null,dreamwalkerMoves:0}:{...e.turn,dreamwalkerMoves:u};return{...e,cells:s,turn:n}}function h(e){return e.gameOver?e:{...e,turn:{team:c[e.turn.team],guideLimit:null,dreamwalkerMoves:0}}}function p(e,r){return e.gameOver||e.turn.guideLimit!==null?e:{...e,turn:{...e.turn,guideLimit:r}}}function b(e){if(e.gameOver)return e.winner;const r=e.cells.filter(i=>i.role==="resonant").length,t=e.cells.filter(i=>i.role==="dissonant").length,s=e.cells.filter(i=>i.role==="resonant"&&i.revealed).length,u=e.cells.filter(i=>i.role==="dissonant"&&i.revealed).length;return s===r?"resonant":u===t?"dissonant":null}function g(e){const r=m();let t=null,s=f;function u(n,a){n!==void 0&&(t=n),a!==void 0&&(s=a??f),r.emit({state:t,language:s})}function i(n){const a=b(n);return a?{...n,gameOver:!0,winner:a}:n}async function l(n){const a=i(n);await o.from("rooms").update({state:a}).eq("id",e)}async function d(){o.channel("room-"+e).on("postgres_changes",{event:"*",schema:"public",table:"rooms",filter:`id=eq.${e}`},a=>u(a.new.state,a.new.language)).subscribe();const{data:n}=await o.from("rooms").select("state, language").eq("id",e).maybeSingle();n&&u(n.state,n.language)}return{init:d,subscribe:r.subscribe,getState:()=>t,getLanguage:()=>s,startGame:async()=>{if(!t||t.phase!=="lobby")return;const n={...t,phase:"active"};await o.from("rooms").update({state:n}).eq("id",e)},resetGame:async()=>{await o.from("rooms").update({state:null}).eq("id",e)},setGuideLimit:async n=>{!t||t.gameOver||await l(p(t,n))},reveal:async n=>{!t||t.gameOver||await l(v(t,n))},endTurn:async()=>{!t||t.gameOver||await l(h(t))}}}function y(e){let r=window.innerWidth,t=window.innerHeight;const s=new ResizeObserver(()=>{const u=window.innerWidth,i=window.innerHeight;(u!==r||i!==t)&&(r=u,t=i,e())});return s.observe(document.documentElement),()=>s.disconnect()}export{g as c,y as o};
