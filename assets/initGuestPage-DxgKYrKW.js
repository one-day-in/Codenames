import{s as v,a as A,t as h,D as T}from"./url-oOUZ7you.js";import{c as R}from"./gameStore-BPAqR2vV.js";const L=3e4,c={GUIDE_RESONANT:"guide-resonant",GUIDE_DISSONANT:"guide-dissonant",WALKER_RESONANT:"walker-resonant",WALKER_DISSONANT:"walker-dissonant"},g=Object.values(c);function O(i){let e=null,t={},a={};function l(){return{[c.GUIDE_RESONANT]:!1,[c.GUIDE_DISSONANT]:!1,[c.WALKER_RESONANT]:!1,[c.WALKER_DISSONANT]:!1}}function s(){if(!e)return l();const r=e.presenceState(),n=l();return Object.values(r).forEach(o=>o.forEach(u=>{u.role in n&&(n[u.role]=!0)})),n}function d(){var n;const r=s();(n=t.onChange)==null||n.call(t,r,g.every(o=>r[o]))}function E(r){e||(e=v.channel("presence-"+i,{config:{presence:{key:r||"host"}}}),e.on("presence",{event:"join"},({key:n})=>{a[n]&&(clearTimeout(a[n]),delete a[n]),d()}).on("presence",{event:"leave"},({key:n})=>{a[n]=setTimeout(()=>{delete a[n],d()},L)}).subscribe(async n=>{n==="SUBSCRIBED"&&r&&(await e.track({role:r}),d())}))}async function m(r){return new Promise(n=>{const o="check-"+i+"-"+Date.now(),u=v.channel(o);let k=!1;function S(w){k||(k=!0,v.removeChannel(u),n(w))}u.on("presence",{event:"sync"},()=>{const w=Object.values(u.presenceState()).some(b=>b.some(_=>_.role===r));S(w)}).subscribe(),setTimeout(()=>S(!1),5e3)})}function f(){e&&(e.untrack(),v.removeChannel(e),e=null),Object.values(a).forEach(clearTimeout),a={}}return{listen:()=>E(null),join:r=>E(r),leave:f,onChange:r=>{t.onChange=r},getPresenceState:s,allConnected:()=>g.every(r=>s()[r]),isRoleTaken:m}}async function N(){if(!("wakeLock"in navigator))return null;try{return await navigator.wakeLock.request("screen")}catch{return null}}async function p(i,e){let t=await N();document.addEventListener("visibilitychange",async()=>{if(document.visibilityState==="visible"&&(t!=null&&t.released&&(t=await N()),e))try{i.leave(),i.join(e)}catch{}}),window.addEventListener("online",()=>{if(e)try{i.leave(),i.join(e)}catch{}})}function G(i){let e=window.innerWidth,t=window.innerHeight;const a=new ResizeObserver(()=>{const l=window.innerWidth,s=window.innerHeight;(l!==e||s!==t)&&(e=l,t=s,i())});return a.observe(document.documentElement),()=>a.disconnect()}function y(i,e){return i==="guide"?e==="resonant"?c.GUIDE_RESONANT:c.GUIDE_DISSONANT:e==="resonant"?c.WALKER_RESONANT:c.WALKER_DISSONANT}function D(i,e,t){return i==="walker"?`${e} ${t.dreamwalker}<br>${t.controllerTaken.replace(`
`,"<br>")}`:t[e==="resonant"?"miniTakenResonant":"miniTakenDissonant"].replace(`
`,"<br>")}async function j(i,{roleType:e,invalidParamsHtml:t}){const{roomId:a,token:l,team:s}=A();if(!a||!l||!s||s!=="resonant"&&s!=="dissonant")return i.innerHTML=t,null;const{data:d,error:E}=await v.from("rooms").select("id, guest_token").eq("id",a).eq("guest_token",l).maybeSingle();if(!d||E){const o=h(T);return i.innerHTML=`<div class="waiting-screen">
            <p>${o.wrongLink.replace(`
`,"<br>")}</p>
        </div>`,null}const m=y(e,s),f=O(a);if(await f.isRoleTaken(m)){const o=h(T);i.innerHTML=`
            <div class="waiting-screen">
                <div class="taken-screen">
                    <p class="taken-screen__icon">ðŸ”’</p>
                    <p class="taken-screen__text">${D(e,s,o)}</p>
                    <button class="lobby__btn" id="forceJoinBtn">${o.forceRejoin}</button>
                </div>
            </div>`,await new Promise(u=>{document.getElementById("forceJoinBtn").addEventListener("click",u,{once:!0})})}f.join(m),p(f,m),document.body.classList.add(`team-${s}`);const n=R(a);return await n.init(),{presence:f,store:n,team:s,roomId:a}}export{j as i,G as o};
