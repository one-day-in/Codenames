import{D as y,s as c}from"./url-DqvqMluG.js";function L(){const e=new Set;let t;return{subscribe(n){if(e.add(n),t!==void 0)try{n(t)}catch(a){console.error(a)}return()=>e.delete(n)},emit(n){t=n,e.forEach(a=>{try{a(n)}catch(u){console.error(u)}})},clear(){e.clear(),t=void 0}}}const g={resonant:"dissonant",dissonant:"resonant"};function _(e,t){if(e.gameOver)return e;const n=e.cells[t];if(n.revealed)return e;const a=e.cells.map((o,i)=>i===t?{...o,revealed:!0}:o);if(n.role==="nightmare")return{...e,cells:a,gameOver:!0,winner:g[e.turn.team]};const u=e.turn.dreamwalkerMoves+1,s=e.turn.guideLimit!==null&&u>=e.turn.guideLimit,r=!(n.role===e.turn.team)||s?{team:g[e.turn.team],guideLimit:null,dreamwalkerMoves:0}:{...e.turn,dreamwalkerMoves:u};return{...e,cells:a,turn:r}}function A(e){return e.gameOver?e:{...e,turn:{team:g[e.turn.team],guideLimit:null,dreamwalkerMoves:0}}}function C(e,t){return e.gameOver||e.turn.guideLimit!==null?e:{...e,turn:{...e.turn,guideLimit:t}}}function N(e){if(e.gameOver)return e.winner;const t=e.cells.filter(s=>s.role==="resonant").length,n=e.cells.filter(s=>s.role==="dissonant").length,a=e.cells.filter(s=>s.role==="resonant"&&s.revealed).length,u=e.cells.filter(s=>s.role==="dissonant"&&s.revealed).length;return a===t?"resonant":u===n?"dissonant":null}function D(e){const t=L();let n=null,a=y;function u(r,o){r!==void 0&&(n=r),o!==void 0&&(a=o??y),t.emit({state:n,language:a})}function s(r){const o=N(r);return o?{...r,gameOver:!0,winner:o}:r}async function f(r){const o=s(r);await c.from("rooms").update({state:o}).eq("id",e)}async function v(){c.channel("room-"+e).on("postgres_changes",{event:"*",schema:"public",table:"rooms",filter:`id=eq.${e}`},o=>u(o.new.state,o.new.language)).subscribe();const{data:r}=await c.from("rooms").select("state, language").eq("id",e).maybeSingle();r&&u(r.state,r.language)}return{init:v,subscribe:t.subscribe,getState:()=>n,getLanguage:()=>a,startGame:async()=>{if(!n||n.phase!=="lobby")return;const r={...n,phase:"active"};await c.from("rooms").update({state:r}).eq("id",e)},resetGame:async()=>{await c.from("rooms").update({state:null}).eq("id",e)},setGuideLimit:async r=>{!n||n.gameOver||await f(C(n,r))},reveal:async r=>{!n||n.gameOver||await f(_(n,r))},endTurn:async()=>{!n||n.gameOver||await f(A(n))}}}function G(e){if(!e.revealed)return"main-cell--hidden";if(e.role==="nightmare")return"main-cell--nightmare";const t=e.imageVariant??e.anomalyVariant??1;return`main-cell--${e.role}-${t}`}function j(e){const t=`mini-cell--${e.role}`;return e.revealed?`${t} mini-cell--revealed`:t}function M(e){return e.revealed?e.role==="nightmare"?"controller__cell--nightmare":e.role==="anomaly"?`controller__cell--anomaly-${e.imageVariant??1}`:`controller__cell--${e.role}-${e.imageVariant??1}`:"controller__cell--hidden"}const k=3e4,h={GUIDE_RESONANT:"guide-resonant",GUIDE_DISSONANT:"guide-dissonant",WALKER_RESONANT:"walker-resonant",WALKER_DISSONANT:"walker-dissonant"},S=Object.values(h);function $(e){let t=null,n={},a={};function u(){return{[h.GUIDE_RESONANT]:!1,[h.GUIDE_DISSONANT]:!1,[h.WALKER_RESONANT]:!1,[h.WALKER_DISSONANT]:!1}}function s(){if(!t)return u();const i=t.presenceState(),l=u();return Object.values(i).forEach(m=>m.forEach(d=>{d.role in l&&(l[d.role]=!0)})),l}function f(){var l;const i=s();(l=n.onChange)==null||l.call(n,i,S.every(m=>i[m]))}function v(i){t||(t=c.channel("presence-"+e,{config:{presence:{key:i||"host"}}}),t.on("presence",{event:"join"},({key:l})=>{a[l]&&(clearTimeout(a[l]),delete a[l]),f()}).on("presence",{event:"leave"},({key:l})=>{a[l]=setTimeout(()=>{delete a[l],f()},k)}).subscribe(async l=>{l==="SUBSCRIBED"&&i&&(await t.track({role:i}),f())}))}async function r(i){return new Promise(l=>{const m="check-"+e+"-"+Date.now(),d=c.channel(m);let E=!1;function b(w){E||(E=!0,c.removeChannel(d),l(w))}d.on("presence",{event:"sync"},()=>{const w=Object.values(d.presenceState()).some(T=>T.some(p=>p.role===i));b(w)}).subscribe(),setTimeout(()=>b(!1),5e3)})}function o(){t&&(t.untrack(),c.removeChannel(t),t=null),Object.values(a).forEach(clearTimeout),a={}}return{listen:()=>v(null),join:i=>v(i),leave:o,onChange:i=>{n.onChange=i},getPresenceState:s,allConnected:()=>S.every(i=>s()[i]),isRoleTaken:r}}async function O(){if(!("wakeLock"in navigator))return null;try{return await navigator.wakeLock.request("screen")}catch{return null}}async function q(e,t){let n=await O();document.addEventListener("visibilitychange",async()=>{if(document.visibilityState==="visible"&&(n!=null&&n.released&&(n=await O()),t))try{e.leave(),e.join(t)}catch{}}),window.addEventListener("online",()=>{if(t)try{e.leave(),e.join(t)}catch{}})}export{S as A,h as R,D as a,j as b,$ as c,M as d,G as g,q as k};
