import{D as y,s as c}from"./i18n-BSQgICzt.js";function O(){const e=new Set;let t;return{subscribe(n){if(e.add(n),t!==void 0)try{n(t)}catch(r){console.error(r)}return()=>e.delete(n)},emit(n){t=n,e.forEach(r=>{try{r(n)}catch(s){console.error(s)}})},clear(){e.clear(),t=void 0}}}const w={resonant:"dissonant",dissonant:"resonant"};function g(e,t){if(e.gameOver)return e;const n=e.cells[t];if(n.revealed)return e;const r=e.cells.map((u,b)=>b===t?{...u,revealed:!0}:u);if(n.role==="nightmare")return{...e,cells:r,gameOver:!0,winner:w[e.turn.team]};const s=e.turn.dreamwalkerMoves+1,l=e.turn.guideLimit!==null&&s>=e.turn.guideLimit,i=!(n.role===e.turn.team)||l?{team:w[e.turn.team],guideLimit:null,dreamwalkerMoves:0}:{...e.turn,dreamwalkerMoves:s};return{...e,cells:r,turn:i}}function T(e){return e.gameOver?e:{...e,turn:{team:w[e.turn.team],guideLimit:null,dreamwalkerMoves:0}}}function L(e,t){return e.gameOver||e.turn.guideLimit!==null?e:{...e,turn:{...e.turn,guideLimit:t}}}function C(e){if(e.gameOver)return e.winner;const t=e.cells.filter(l=>l.role==="resonant").length,n=e.cells.filter(l=>l.role==="dissonant").length,r=e.cells.filter(l=>l.role==="resonant"&&l.revealed).length,s=e.cells.filter(l=>l.role==="dissonant"&&l.revealed).length;return r===t?"resonant":s===n?"dissonant":null}function D(e){const t=O();let n=null,r=y;function s(i,u){i!==void 0&&(n=i),u!==void 0&&(r=u??y),t.emit({state:n,language:r})}function l(i){const u=C(i);return u?{...i,gameOver:!0,winner:u}:i}async function f(i){const u=l(i);await c.from("rooms").update({state:u}).eq("id",e)}async function d(){c.channel("room-"+e).on("postgres_changes",{event:"*",schema:"public",table:"rooms",filter:`id=eq.${e}`},u=>s(u.new.state,u.new.language)).subscribe();const{data:i}=await c.from("rooms").select("state, language").eq("id",e).maybeSingle();i&&s(i.state,i.language)}return{init:d,subscribe:t.subscribe,getState:()=>n,getLanguage:()=>r,startGame:async()=>{if(!n||n.phase!=="lobby")return;const i={...n,phase:"active"};await c.from("rooms").update({state:i}).eq("id",e)},resetGame:async()=>{await c.from("rooms").update({state:null}).eq("id",e)},setGuideLimit:async i=>{!n||n.gameOver||await f(L(n,i))},reveal:async i=>{!n||n.gameOver||await f(g(n,i))},endTurn:async()=>{!n||n.gameOver||await f(T(n))}}}function G(e){return e.revealed?e.role==="anomaly"?`main-cell--anomaly-${e.anomalyVariant||1}`:`main-cell--${e.role}`:"main-cell--hidden"}function M(e){const t=`mini-cell--${e.role}`;return e.revealed?`${t} mini-cell--revealed`:t}function j(e){return e.revealed?e.role==="anomaly"?"controller__cell--anomaly":`controller__cell--${e.role}`:"controller__cell--hidden"}const N=3e3,m={GUIDE_RESONANT:"guide-resonant",GUIDE_DISSONANT:"guide-dissonant",WALKER_RESONANT:"walker-resonant",WALKER_DISSONANT:"walker-dissonant"},k=Object.values(m);function q(e){let t=null,n={},r={};function s(){if(!t)return l();const o=t.presenceState(),a=l();return Object.values(o).forEach(v=>v.forEach(h=>{h.role in a&&(a[h.role]=!0)})),a}function l(){return{[m.GUIDE_RESONANT]:!1,[m.GUIDE_DISSONANT]:!1,[m.WALKER_RESONANT]:!1,[m.WALKER_DISSONANT]:!1}}function f(o){return k.every(a=>o[a])}function d(){var a;const o=s();(a=n.onChange)==null||a.call(n,o,f(o))}function i(o){return t=c.channel("presence-"+e,{config:{presence:{key:o||"display"}}}),t.on("presence",{event:"join"},({key:a})=>{r[a]&&(clearTimeout(r[a]),delete r[a]),d()}).on("presence",{event:"leave"},({key:a})=>{r[a]=setTimeout(()=>{delete r[a],d()},N)}).subscribe(async a=>{a==="SUBSCRIBED"&&o&&(await t.track({role:o}),d())}),t}async function u(o){return new Promise(a=>{const v=c.channel("presence-"+e);v.on("presence",{event:"sync"},()=>{const h=Object.values(v.presenceState()).some(S=>S.some(p=>p.role===o));c.removeChannel(v),a(h)}).subscribe(),setTimeout(()=>{c.removeChannel(v),a(!1)},3e3)})}function b(){t&&(t.untrack(),c.removeChannel(t),t=null),Object.values(r).forEach(clearTimeout),r={}}return{listen:()=>i(null),join:o=>i(o),leave:b,onChange:o=>{n.onChange=o},getPresenceState:s,allConnected:()=>f(s()),isRoleTaken:u}}async function E(){if(!("wakeLock"in navigator))return null;try{return await navigator.wakeLock.request("screen")}catch{return null}}function A(e){document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&e()})}function _(e){window.addEventListener("online",e)}async function U(e,t,n){let r=await E();document.addEventListener("visibilitychange",async()=>{document.visibilityState==="visible"&&(r!=null&&r.released)&&(r=await E())});async function s(){if(document.visibilityState==="visible"&&t)try{e.leave(),await e.join(t),n==null||n()}catch{}}A(s),_(s)}export{k as A,m as R,D as a,M as b,q as c,j as d,G as g,U as k};
