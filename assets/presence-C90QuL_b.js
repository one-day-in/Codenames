import{D as g,s as c}from"./url-DqvqMluG.js";function y(){const e=new Set;let n;return{subscribe(t){if(e.add(t),n!==void 0)try{t(n)}catch(s){console.error(s)}return()=>e.delete(t)},emit(t){n=t,e.forEach(s=>{try{s(t)}catch(u){console.error(u)}})},clear(){e.clear(),n=void 0}}}const w={resonant:"dissonant",dissonant:"resonant"};function N(e,n){if(e.gameOver)return e;const t=e.cells[n];if(t.revealed)return e;const s=e.cells.map((o,a)=>a===n?{...o,revealed:!0}:o);if(t.role==="nightmare")return{...e,cells:s,gameOver:!0,winner:w[e.turn.team]};const u=e.turn.dreamwalkerMoves+1,i=e.turn.guideLimit!==null&&u>=e.turn.guideLimit,r=!(t.role===e.turn.team)||i?{team:w[e.turn.team],guideLimit:null,dreamwalkerMoves:0}:{...e.turn,dreamwalkerMoves:u};return{...e,cells:s,turn:r}}function A(e){return e.gameOver?e:{...e,turn:{team:w[e.turn.team],guideLimit:null,dreamwalkerMoves:0}}}function L(e,n){return e.gameOver||e.turn.guideLimit!==null?e:{...e,turn:{...e.turn,guideLimit:n}}}function R(e){if(e.gameOver)return e.winner;const n=e.cells.filter(i=>i.role==="resonant").length,t=e.cells.filter(i=>i.role==="dissonant").length,s=e.cells.filter(i=>i.role==="resonant"&&i.revealed).length,u=e.cells.filter(i=>i.role==="dissonant"&&i.revealed).length;return s===n?"resonant":u===t?"dissonant":null}function k(e){const n=y();let t=null,s=g;function u(r,o){r!==void 0&&(t=r),o!==void 0&&(s=o??g),n.emit({state:t,language:s})}function i(r){const o=R(r);return o?{...r,gameOver:!0,winner:o}:r}async function f(r){const o=i(r);await c.from("rooms").update({state:o}).eq("id",e)}async function v(){c.channel("room-"+e).on("postgres_changes",{event:"*",schema:"public",table:"rooms",filter:`id=eq.${e}`},o=>u(o.new.state,o.new.language)).subscribe();const{data:r}=await c.from("rooms").select("state, language").eq("id",e).maybeSingle();r&&u(r.state,r.language)}return{init:v,subscribe:n.subscribe,getState:()=>t,getLanguage:()=>s,startGame:async()=>{if(!t||t.phase!=="lobby")return;const r={...t,phase:"active"};await c.from("rooms").update({state:r}).eq("id",e)},resetGame:async()=>{await c.from("rooms").update({state:null}).eq("id",e)},setGuideLimit:async r=>{!t||t.gameOver||await f(L(t,r))},reveal:async r=>{!t||t.gameOver||await f(N(t,r))},endTurn:async()=>{!t||t.gameOver||await f(A(t))}}}function E(e){if(e.role==="nightmare")return"cell--nightmare";if(e.role==="anomaly")return`cell--anomaly-${e.imageVariant??e.anomalyVariant??1}`;const n=e.imageVariant??1;return`cell--${e.role}-${n}`}function G(e){const n=["cell"];return e.revealed?(n.push("cell--revealed"),n.push(E(e)),n.join(" ")):(n.push("cell--hidden"),n.join(" "))}function j(e){const n=["cell"];return e.revealed&&n.push("cell--revealed"),n.push(E(e)),n.join(" ")}function M(e){const n=["cell"];return e.revealed?(n.push("cell--revealed"),n.push(E(e))):n.push("cell--hidden"),n.join(" ")}const _=3e4,m={GUIDE_RESONANT:"guide-resonant",GUIDE_DISSONANT:"guide-dissonant",WALKER_RESONANT:"walker-resonant",WALKER_DISSONANT:"walker-dissonant"},T=Object.values(m);function U(e){let n=null,t={},s={};function u(){return{[m.GUIDE_RESONANT]:!1,[m.GUIDE_DISSONANT]:!1,[m.WALKER_RESONANT]:!1,[m.WALKER_DISSONANT]:!1}}function i(){if(!n)return u();const a=n.presenceState(),l=u();return Object.values(a).forEach(h=>h.forEach(d=>{d.role in l&&(l[d.role]=!0)})),l}function f(){var l;const a=i();(l=t.onChange)==null||l.call(t,a,T.every(h=>a[h]))}function v(a){n||(n=c.channel("presence-"+e,{config:{presence:{key:a||"host"}}}),n.on("presence",{event:"join"},({key:l})=>{s[l]&&(clearTimeout(s[l]),delete s[l]),f()}).on("presence",{event:"leave"},({key:l})=>{s[l]=setTimeout(()=>{delete s[l],f()},_)}).subscribe(async l=>{l==="SUBSCRIBED"&&a&&(await n.track({role:a}),f())}))}async function r(a){return new Promise(l=>{const h="check-"+e+"-"+Date.now(),d=c.channel(h);let O=!1;function S(p){O||(O=!0,c.removeChannel(d),l(p))}d.on("presence",{event:"sync"},()=>{const p=Object.values(d.presenceState()).some(b=>b.some(C=>C.role===a));S(p)}).subscribe(),setTimeout(()=>S(!1),5e3)})}function o(){n&&(n.untrack(),c.removeChannel(n),n=null),Object.values(s).forEach(clearTimeout),s={}}return{listen:()=>v(null),join:a=>v(a),leave:o,onChange:a=>{t.onChange=a},getPresenceState:i,allConnected:()=>T.every(a=>i()[a]),isRoleTaken:r}}export{T as A,m as R,j as a,M as b,k as c,U as d,G as g};
